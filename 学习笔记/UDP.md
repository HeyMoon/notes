UDP是简单的面向数据报的运输层协议：进程的每一个输出操作都正好产生一个UDP数据报，并组装成一份待发送的IP数据报。

UDP不提供可靠性。

应用程序必须关心IP数据报的长度。如果它超过网络的MTU，那么就要对IP数据报进行分片。如果需要，源端到目的端之间的每个网络都要进行分片，并不只是发送端主机连接的第一个网络才这样做。

## IP分片
物理网络层一般要限制每次发送数据帧的最大长度。任何时候IP层接收到一份要发送的IP数据报时，它要判断向本地哪个接口发送数据（选路），并查询该接口获得其MTU。IP把MTU与数据报长度进行比较，如果需要则进行分片。分片可以发生在原始发送端主机上，也可以发生在中间路由器上。

把一份IP数据报分片以后，只有到达目的地才进行重新组装。重新组装由目的端IP层来完成，其目的是使分片和重新组装过程对传输层(TCP和UDP)是透明的。已经分片的数据报可能会再次进行分片。IP首部中包含的数据为分片和重新组装提供了足够的信息。

标志字段中有一个比特称作“不分片”位。如果将这一比特置1，IP将不对数据报进行分片。相反把数据报丢弃，并发送一个ICMP差错报文给起始端。

当IP数据报被分片后，每一片都成为一个分组，具有自己的IP首部，并在选择路由时与其他分组独立。这样，当数据报的这些片到达目的端时有可能会失序，但是在IP首部中有足够的信息让接收端能正确组装这些数据报 。

尽管IP分片过程看起来是透明的，但是有一点让人不想使用它：即使只丢失一片数据也要重传整个数据报。为什么会发生这种情况？因为IP层本身没有超市重传的机制--由更高层来负责超时和重传。

任何传输层首部只出现在第一片数据中。

IP数据报是指 IP层端到端的传输单元(在分片之前和重新组装之后)，分组是指在IP层和链路层之间传送的数据单元。一个分组可以是一个完整的IP数据报，也可以是 IP数据报的一个分片。

## ICMP不可达差错（需要分片）
发生ICMP不可达差错的另一种情况是，当路由器收到一份需要分片的数据报，而在IP首部有设置了不分片（DF）的标志比特。当某个程序需要判断到达目的端的路途中最小的MTU是多少--称为路径MTU发现机制，那么这个差错就可以被该程序使用。

## 用Traceroute确定路径MTU
尽管大多数系统不支持路径MTU发现功能，但是可以很容易的修改Traceroute程序，用它来确定路径MTU。要做的是发送分组，并设置“不分片”标志比特。发送的第一个分组的长度正好与出口MTU相等，每次收到ICMP“不能分片”差错时，就减少分组的长度。如果路由器发送的ICMP差错报文是新格式，包含出口MTU，那么就用该MTU值来发送，否则就用下一个最小的MTU值来发送。MTU值的个数是有限的，因此在我们的程序中有一些由近似值构成的表，取下一个最小MTU值来发送。

## 采用UDP的路径MTU发现

## 最大UDP数据报长度
理论上IP数据报的最大长度是65535字节，这是由IP首部16比特总长度字段所限制的。去除20字节的IP首部和8字节的UDP首部，UDP数据报中用户数据的最大长度为65507字节。但是大多数实现所提供的长度比这个最大值小。

在3.2节中提过，要求主机必须能够接收最短为576字节的IP数据报。在许多UDP应用程序的设计中，其应用程序数据被限制成512字节或更小。
